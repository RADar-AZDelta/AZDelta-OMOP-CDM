{# Copyright 2022 RADar-AZDelta #}
{# SPDX-License-Identifier: gpl3+ #}
WITH cte AS (
    SELECT
        CONCAT('EPD_', e.DIAG_ID) as measurement_id	
        ,e.PATIENTNR as person_id
        ,stc.source_code as measurement_concept_id
        ,DATE(COALESCE(e.DATUM, e.REGISTRATIONDATE)) as measurement_date
        ,DATETIME(
            DATE(COALESCE(e.DATUM, e.REGISTRATIONDATE)), 
            PARSE_TIME('%H:%M', IF(e.STARTTIJD IS NOT NULL AND TRIM(e.STARTTIJD) <> '', TRIM(e.STARTTIJD), "00:00"))
        ) as measurement_datetime    
        ,IF(e.STARTTIJD IS NOT NULL AND TRIM(e.STARTTIJD) <> '', TRIM(e.STARTTIJD), "00:00") as measurement_time
        ,'ADMINISTRATION_RECORD' as measurement_type_concept_id
        ,cast(null as string) as operator_concept_id
        ,cast(null as float64) as value_as_number
        ,cast(null as string) as value_as_concept_id
        ,cast(null as string) as unit_concept_id
        ,cast(null as float64) as range_low
        ,cast(null as float64) as range_high
        ,e.ARTSCODE as provider_id
        --,ARRAY_AGG(vs.x IGNORE NULLS ORDER BY vs.x ASC)[SAFE_OFFSET(0)] as visit_occurrence_id
        --,cast(null as string) as visit_detail_id
        ,stc.source_code as measurement_source_value
        ,stc.source_code as measurement_source_concept_id
        ,cast(null as string) as unit_source_value
        ,cast(null as string) as unit_source_concept_id
        ,cast(null as string) as value_source_value 
        ,cast(null as string) as measurement_event_id
        ,cast(null as string) as meas_event_field_concept_id
    FROM `{{project_id}}.{{dataset_id_raw}}.DOSSIER_EPDDIAG` e
    LEFT JOIN `{{project_id}}.{{dataset_id_raw}}.CODELYST_CODEOMS` cc ON e.CODE = cc.CODE
    INNER JOIN `{{project_id}}.{{dataset_id_omop}}.source_to_concept_map` stc ON concat('EPD_', e.CODE) = stc.source_code
    INNER JOIN `{{project_id}}.{{dataset_id_omop}}.concept` c ON stc.target_concept_id = c.concept_id
    WHERE e.CODE IS NOT NULL AND TRIM(e.CODE) <> '' 
        AND cc.Omschrijving IS NOT NULL AND TRIM(cc.Omschrijving) <> ''
        AND e.DIAG_ID IS NOT NULL AND TRIM(e.DIAG_ID) <> ''
        AND e.PATIENTNR IS NOT NULL AND TRIM(e.PATIENTNR) <> ''
        AND c.domain_id = 'Measurement'
)
SELECT cte.*
    , ARRAY_AGG(v.visit_occurrence_id ORDER BY v.visit_start_datetime DESC LIMIT 1)[OFFSET(0)] as visit_occurrence_id
    , ARRAY_AGG(vd.visit_detail_id ORDER BY vd.visit_detail_start_datetime DESC LIMIT 1)[OFFSET(0)] as visit_detail_id
FROM cte
LEFT OUTER JOIN {{project_id}}.{{dataset_id_work}}.visit_occurrence_upload v ON v.person_id = cte.person_id AND cte.measurement_datetime >= v.visit_start_datetime and cte.measurement_datetime <= v.visit_end_datetime 
LEFT OUTER JOIN {{project_id}}.{{dataset_id_work}}.visit_detail_upload vd ON v.visit_occurrence_id = vd.visit_occurrence_id AND cte.measurement_datetime >= vd.visit_detail_start_datetime and cte.measurement_datetime <= vd.visit_detail_start_datetime
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21
