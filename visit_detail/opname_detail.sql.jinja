{# Copyright 2022 RADar-AZDelta #}
{# SPDX-License-Identifier: gpl3+ #}
with cte_visit_detail as (
    select 'OPNAME_OPNMUT' as SOURCE, o.PATIENTNR as PAT_ID, o.INSCHRNR as VISIT_ID, o.PLANNR, om.INGDAT as START_DATE, om.INGTIJD as START_TIME, om.EINDDAT as END_DATE, om.EINDTIJD as END_TIME, o.LOCATIE as CAMPUS, om.AFDELING as WARD, om.KAMER as ROOM, cast(om.BEDNR as STRING) as BED, '' as BESTEMAFD, om.SPECIALISM, o.AANMELARTS as ADMITTING_DOCTOR, om.BEHANDELAA as PERFORMING_DOCTOR, om.MUTATIEID as SOURCEOBJID
    from {{project_id}}.{{dataset_id_raw}}.OPNAME_OPNMUT om
    inner join {{project_id}}.{{dataset_id_raw}}.OPNAME_OPNAME o on o.PLANNR = om.PLANNR
    where o.INSCHRNR is not null and o.INSCHRNR <> ''
        and o.WORKFLOWSTATUS <> 'DT000125' -- GEANNULEERD
    union all
    select 'OK_OKINFO' as SOURCE, o.PATIENTNR as PAT_ID, oi.EPISODENR as VISIT_ID, o.PLANNR, okr.STARTDATE as START_DATE, okr.STARTTIME as START_TIME, okr.VERTREKDAT as END_DATE, okr.VERTREKTIJ as END_TIME, oi.ZKHLOCCODE as CAMPUS, okr.LOCATIEAFD as WARD, oi.OKKAMER as ROOM, '01' as BED, okr.BESTEMAFD, oi.SPECIALISM, o.AANMELARTS as ADMITTING_DOCTOR, oi.SNIJD_SPEC as PERFORMING_DOCTOR, oi.OPERATIENR as SOURCEOBJID
    from {{project_id}}.{{dataset_id_raw}}.OK_OKINFO oi
    left join {{project_id}}.{{dataset_id_raw}}.OK_OKROUTE okr on okr.OPERATIENR = oi.OPERATIENR
    left join {{project_id}}.{{dataset_id_raw}}.OK_OKKAMERS okk on okr.LOCATIE = okk.CODE
    left join {{project_id}}.{{dataset_id_raw}}.CSZISLIB_LOCATION okl on okl.LOCATIONID = okk.LOCATIONID
    inner join {{project_id}}.{{dataset_id_raw}}.OPNAME_OPNAME o on o.PLANNR = oi.OPNAMENR
    where oi.EPISODENR is not null and oi.EPISODENR <> ''
        and o.WORKFLOWSTATUS <> 'DT000125' -- GEANNULEERD
    union all
    select 'SEH_SEHMUT' as SOURCE, o.PATIENTNR as PAT_ID, o.INSCHRNR as VISIT_ID, o.PLANNR, sm.DATUM as START_DATE, sm.BEGINTIJD as START_TIME, sm.EINDDATUM as END_DATE, sm.EINDTIJD as END_TIME, sm.ZKHLOCCODE as CAMPUS, 'SEH' as WARD, sm.BEHKAMERCO as ROOM, sm.BEDNR as BED,
      '' as BESTEMAFD, o.SPECIALISM, o.AANMELARTS as ADMITTING_DOCTOR, sm.ARTSID as PERFORMING_DOCTOR, sm.SEHMUTID as SOURCEOBJID
    from {{project_id}}.{{dataset_id_raw}}.SEH_SEHMUT sm
    inner join {{project_id}}.{{dataset_id_raw}}.SEH_SEHREG sr on sr.SEHID = sm.SEHID
    inner join {{project_id}}.{{dataset_id_raw}}.OPNAME_OPNAME o on o.PLANNR = sr.OPNAMEID
    where o.INSCHRNR is not null and o.INSCHRNR <> ''
        and o.WORKFLOWSTATUS <> 'DT000125' -- GEANNULEERD
), cte_visit_detail2 as (
    select 
        concat(VISIT_ID, '_', START_DATE, '_', START_TIME) as visit_detail_id 
        ,od.PAT_ID as person_id
        ,e.SOORTINSCH as visit_detail_concept_id
        ,CAST(od.START_DATE as DATE) as visit_detail_start_date
        ,DATETIME(
           CAST(od.START_DATE as DATE), 
           CASE
               WHEN REGEXP_CONTAINS(od.START_TIME, r'^[0-9]{2}:[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M:%S', od.START_TIME)
               WHEN REGEXP_CONTAINS(od.START_TIME, r'^[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M', od.START_TIME)
               ELSE TIME(0, 0, 0)
           END
        ) as visit_detail_start_datetime
        ,coalesce(CAST(od.END_DATE as DATE), DATE(2099,12,31)) as visit_detail_end_date
        ,DATETIME(
           coalesce(CAST(od.END_DATE as DATE), DATE(2099,12,31)), 
           CASE
               WHEN REGEXP_CONTAINS(od.END_TIME, r'^[0-9]{2}:[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M:%S', od.END_TIME)
               WHEN REGEXP_CONTAINS(od.END_TIME, r'^[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M', od.END_TIME)
               ELSE TIME(0, 0, 0)
           END
        ) as visit_detail_end_datetime
        ,'EPISODE_RECORD' as visit_detail_type_concept_id
        ,od.PERFORMING_DOCTOR as provider_id
        ,concat(od.CAMPUS, '_', od.WARD) as care_site_id
        ,e.SOORTINSCH as visit_detail_source_value
        ,cast(null as string) as visit_detail_source_concept_id
        ,o.HERKOMST as admitted_from_concept_id
        ,o.HERKOMST as admitted_from_source_value
        ,o.BESTEMMING as discharged_to_concept_id
        ,o.BESTEMMING as discharged_to_source_value 
        ,cast(null as string) as parent_visit_detail_id
        ,od.VISIT_ID as visit_occurrence_id
    from cte_visit_detail od  
    inner join {{project_id}}.{{dataset_id_raw}}.OPNAME_OPNAME o on od.VISIT_ID = o.INSCHRNR
    left outer join {{project_id}}.{{dataset_id_raw}}.EPISODE_INSCHRIJVING e on e.DBCNUMMER = o.INSCHRNR
    where o.WORKFLOWSTATUS <> 'DT000125' -- GEANNULEERD
        and CAST(od.START_DATE as DATE) < CURRENT_DATE()
), cte_visit_detail3 as ( --remove duplicates
    select *, ROW_NUMBER() OVER (PARTITION BY visit_detail_id ORDER BY visit_detail_start_datetime asc) as row_number 
    from cte_visit_detail2
), cte_visit_detail4 as (
    select * except(row_number) 
    from cte_visit_detail3
    where row_number = 1
)
select *
    ,LAG (visit_detail_id) OVER (partition by visit_detail_id ORDER BY visit_detail_start_datetime asc) as preceding_visit_detail_id
from cte_visit_detail4
order by 2, 5 desc 