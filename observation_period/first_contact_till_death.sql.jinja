with cte_first_encounter as (
    select PATIENTNR, min(START_DATE) as START_DATE
    from (
        select o.PATIENTNR
        ,DATETIME(
            coalesce(CAST(o.OPNDAT as DATE), DATE(2099,12,31)), 
            PARSE_TIME('%H:%M', IF(REGEXP_CONTAINS(o.OPNTIJD, r'^[0-9]{2}:[0-9]{2}$'), o.OPNTIJD, '00:00'))
        ) as START_DATE
        from {{project_id}}.{{dataset_id_raw}}.OPNAME_OPNAME o
        union all
        select e.PATIENTNR
        ,DATETIME(
            coalesce(CAST(ei.BEGINDAT as DATE), DATE(2099,12,31)), 
            PARSE_TIME('%H:%M', IF(REGEXP_CONTAINS(ei.BEGINTIJD, r'^[0-9]{2}:[0-9]{2}$'), ei.BEGINTIJD, '00:00'))
        ) as START_DATE
        from {{project_id}}.{{dataset_id_raw}}.EPISODE_EPISODE e
        inner join {{project_id}}.{{dataset_id_raw}}.EPISODE_INSCHRIJVING ei on ei.EPISODE = e.EPISODE
    ) t
    where t.PATIENTNR is not null
    group by t.PATIENTNR
)
select
    concat('FIRST_ENCOUNTER_', o.PATIENTNR) as observation_period_id
    ,o.PATIENTNR as person_id
    ,CAST(o.START_DATE as DATE) as observation_period_start_date
    ,coalesce(CAST(p.OVERLDAT as DATE), DATE(2099, 12, 31)) as observation_period_end_date
    ,'FIRST_ENCOUNTER_RECORD' as period_type_concept_id
from cte_first_encounter o
inner join {{project_id}}.{{dataset_id_raw}}.PATIENT_PATIENT p on p.PATIENTNR = o.PATIENTNR