WITH cte AS (
    SELECT
        CONCAT('DaVinci_', veldnaam.tefName) AS observation_id	
        ,PATSIT.patsitinternalnumber AS person_id
        ,scm.source_code AS observation_concept_id
        ,cast(parse_date("%Y%m%d",REQ.ReqDate) as date) AS observation_date
        ,DATETIME(DATE(cast(parse_date("%Y%m%d",REQ.ReqDate) as date)),TIME(0, 0, 0)) AS observation_datetime
        ,'ADMINISTRATION_RECORD' AS observation_type_concept_id
        ,cast(NULL AS FLOAT64) AS value_as_number
        ,cast(NULL AS STRING) AS value_as_string
        ,CAST(NULL AS STRING) AS value_as_concept_id
        ,cast(NULL AS STRING) AS qualifier_concept_id
        ,cast(NULL AS STRING) AS unit_concept_id
        ,doc1.doc_SysID AS provider_id
        --,ARRAY_AGG(vs.x IGNORE NULLS ORDER BY vs.x ASC)[SAFE_OFFSET(0)] visit_occurrence_id
        --,cast(NULL AS STRING) AS visit_detail_id
        ,scm.source_code AS observation_source_value
        ,scm.source_code AS observation_source_concept_id
        ,cast(NULL AS STRING) AS unit_source_value
        ,cast(NULL AS STRING) AS qualifier_source_value
        ,cast(null as string) as value_source_value
        ,cast(NULL AS string) AS observation_event_id
        ,cast(NULL AS STRING) AS obs_event_field_concept_id
            FROM ({{project_id}}.davinci.CodapCodes AS COD
            INNER JOIN {{project_id}}.davinci.Protocol AS PRO  ON cod.proID = pro.PRO_SYSID
            join {{project_id}}.davinci.ProtocolTemplateValue as templ on templ.proID = pro.pro_SysID
            join {{project_id}}.davinci.TemplateField as veldnaam on tef_SysID = templ.ptvDynGuid
            INNER JOIN ({{project_id}}.davinci.Request AS REQ INNER JOIN ({{project_id}}.davinci.RequestOrigin AS REO1
            INNER JOIN {{project_id}}.davinci.RequestOriginType ret1 ON reo1.retID = ret1.RET_SYSID) ON REQ.reoID = reo1.REO_SYSID
            INNER JOIN {{project_id}}.davinci.Site AS SIT1 ON REQ.sitID = sit1.SIT_SYSID
            INNER JOIN {{project_id}}.davinci.Location LOC ON req.locID = LOC.LOC_SYSID
            INNER JOIN ({{project_id}}.davinci.DoctorAddress AS DOA1
                INNER JOIN {{project_id}}.davinci.TypeAddress tad1 ON doa1.tadID = tad1.TAD_SYSID
                INNER JOIN {{project_id}}.davinci.Doctor doc1 ON doa1.docID = doc1.DOC_SYSID
                INNER JOIN {{project_id}}.davinci.Site AS SIT2 ON doa1.sitID = sit2.SIT_SYSID
                INNER JOIN {{project_id}}.davinci.Language lan1 ON doc1.lanID = lan1.LAN_SYSID) ON REQ.doaID = doa1.DOA_SYSID
            INNER JOIN ({{project_id}}.davinci.PatientSite AS PATSIT
                INNER JOIN {{project_id}}.davinci.Patient AS PAT ON patsit.patID = pat.PAT_SYSID
                INNER JOIN {{project_id}}.davinci.Site AS SIT3 ON patsit.sitID = sit3.SIT_SYSID
                LEFT JOIN ({{project_id}}.davinci.DoctorAddress AS DOA2
                  INNER JOIN {{project_id}}.davinci.Doctor doc2 ON doa2.docID = doc2.DOC_SYSID
                  INNER JOIN {{project_id}}.davinci.Site AS SIT4 ON doa2.sitID = sit4.SIT_SYSID
                  INNER JOIN {{project_id}}.davinci.Language lan2 ON doc2.lanID = lan2.LAN_SYSID) ON patsit.refGPID = doa2.DOA_SYSID) ON REQ.patsitID = patsit.PATSIT_SYSID) ON req.REQ_SYSID = pro.reqID
                      INNER JOIN {{project_id}}.davinci.CodapOrgan org ON cod.orgID = org.ORG_SYSID
                      INNER JOIN {{project_id}}.davinci.CodapDiagnostic dgn ON cod.dgnID = dgn.DGN_SYSID
        WHERE 1=1
        AND COD_SYSID <> '99999999-9999-9999-9999-999999999999'   -- waarschijnlijk testpatiÃ«nt/testrecord
        AND PROVALIDATED = true
        AND REQSYSRD >= 20220101000000 -- datum
        and veldnaam.tefName in ('dominante graad', 'secundaire graad', 'totale gleasonscore')
        and ptvDynValue not in ('<[totale gleasonscore]>')
        order by patsitinternalnumber
                      )
    INNER JOIN `omop.source_to_concept_map` scm ON concat('DaVinci_', veldnaam.tefName) = scm.source_code
    INNER JOIN `omop.concept` c ON scm.target_concept_id = c.concept_id
    WHERE veldnaam.tefName IS NOT NULL AND TRIM(veldnaam.tefName) <> '' 
        -- AND cc.Omschrijving IS NOT NULL AND TRIM(cc.Omschrijving) <> ''
        -- AND e.DIAG_ID IS NOT NULL AND TRIM(e.DIAG_ID) <> ''
        AND PATSIT.patsitinternalnumber IS NOT NULL AND TRIM(PATSIT.patsitinternalnumber) <> ''
        AND c.domain_id not in ("Condition","Procedure","Drug","Measurement","Device")
)
SELECT cte.*
    , ARRAY_AGG(v.visit_occurrence_id ORDER BY v.visit_start_datetime DESC LIMIT 1)[OFFSET(0)] as visit_occurrence_id
    , ARRAY_AGG(vd.visit_detail_id ORDER BY vd.visit_detail_start_datetime DESC LIMIT 1)[OFFSET(0)] as visit_detail_id
FROM cte
LEFT OUTER JOIN omop_work.visit_occurrence_upload v ON v.person_id = cte.person_id AND cte.observation_datetime >= v.visit_start_datetime and cte.observation_datetime <= v.visit_end_datetime 
LEFT OUTER JOIN omop_work.visit_detail_upload vd ON v.visit_occurrence_id = vd.visit_occurrence_id AND cte.observation_datetime >= vd.visit_detail_start_datetime and cte.observation_datetime <= vd.visit_detail_start_datetime
inner join omop_work.person_upload p
on cte.person_id = p.person_id
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19
