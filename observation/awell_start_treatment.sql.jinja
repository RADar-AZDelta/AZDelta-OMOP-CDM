with awell_vragenlijsten as (select distinct 
	fq.form_id
	,fq.question_id
	,fq.label
	,fq.label_en
	,fq.sub_question_id
	,fq.sub_label
	,fq.sub_label_en
	,fr.response_label_en as structured_answer_en
	,fr.response_label_nl as structured_answer_nl
	,IF(fr.response_label_nl is not null, r.response_value, null) as structured_answer_code
	,IF(fr.response_label_nl is null, r.response_value, null) as free_answer
	,u.patient_code
	,u.doctor_id
	,r.submission_date
	,r.step_id
	,r.episode_name
	
from {{project_id}}.awell.form_questions fq
inner join {{project_id}}.awell.responses r on fq.form_id = r.form_id 
	and fq.question_id = r.question_id 
	and ((fq.sub_question_id is null and r.sub_question_id is null) or (fq.sub_question_id = r.sub_question_id))
left outer join {{project_id}}.awell.form_responses fr on fr.form_id = fq.form_id 
	and fr.question_id = fq.question_id
	and fr.response_value = r.response_value
inner join {{project_id}}.awell.users u on u.user_id = r.user_id
where fq.form_id in ('start_form_lungcancer_treatment', '40f9b122-73d7-405f-bbd7-ed136293edcc'
,'62f4451b-d381-4676-a4e1-5088c37cd732','lungcancer_form_treatment_start')
order by fq.form_id, fq.question_id, fq.sub_question_id, structured_answer_nl, free_answer)


select distinct concat('AWELL_', form_id, '_', coalesce(sub_question_id, question_id), cast(submission_date as date), '_', patient_code) as observation_id
,cast(patient_code as string) as person_id
,case when question_id = 'TX' then concat('AWELL_', question_id, '_', structured_answer_code) else 
concat ('AWELL_', question_id) end as observation_concept_id
,cast(submission_date as date) as observation_date
,cast(substring(cast(submission_date as string), 1,19) as datetime)  as observation_datetime
,cast(null as string) as observation_type_concept_id 
,cast(null as float64) as value_as_number
,cast(null as string) as value_as_string
,case when question_id = 'TREATINT' then concat('AWELL_', question_id, '_', structured_answer_code) end as value_as_concept_id
,cast(null as string) as qualifier_concept_id
,cast(null as string) as unit_concept_id
,cast(null as string) as provider_id
,cast(null as string) as visit_occurrence_id
,cast(null as string) as visit_detail_id
,concat('AWELL_', question_id, '_', structured_answer_code) as observation_source_value
,cast(null as string) as observation_source_concept_id
,cast(null as string) as unit_source_value
,cast(null as string) as qualifier_source_value
,cast(null as string) as observation_event_id
,cast(null as string) as obs_event_field_concept_id


from awell_vragenlijsten
where question_id in ('TX','TREATINT')  and structured_answer_code in ('no_treatment',
'no_treatment_palliative', 'no_treatment_with_weekly_follow_up', '1','2', '999')

order by person_id 


