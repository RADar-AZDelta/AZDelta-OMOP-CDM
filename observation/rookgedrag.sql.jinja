with hixvragenlijsten as (
  SELECT distinct 
    vragenlijst.opslagid, 
    vraagid, 
    korteoms, 
    antwoorden.patientnr, 
    vragenlijst.datum, 
    lijstnaam.lijstnaam,
    antwoorden.opslagid antwoord_opslagid, 
    stelling, 
    keuzelijst.omschr, 
    antwoord
  from {{project_id}}.hix.VRLIJST_VROPSLG antwoorden
  join {{project_id}}.hix.VRLIJST_LSTOPSLG  as vragenlijst on vragenlijst.OPSLAGID = antwoorden.BEANTWID
  join {{project_id}}.hix.VRLIJST_LIJSTDEF  as lijstnaam on lijstnaam.LIJSTID = vragenlijst.LIJSTID
  join {{project_id}}.hix.VRLIJST_VRAGEN as vragen on vragen.VRAAGID = REALVRID
  left outer join {{project_id}}.hix.VRLIJST_KEUZELST as keuzelijst on  keuzelijst.CODE = antwoorden.Antwoord
  where lijstnaam.lijstnaam in ("Roken") 
)
,cte as (
select distinct
    concat('roken_', antwoord_opslagid, '_', patientnr, '_', datum) as observation_id
    ,patientnr as person_id
    ,case when stelling = "Roken" then concat('HIXVRAGENLIJSTEN_', antwoord, '_', vraagid) else concat('HIXVRAGENLIJSTEN_', vraagid) end as observation_concept_id
    ,date(datum) as observation_date
    ,datetime(datum) as observation_datetime
    ,'ADMINISTRATION_RECORD' as observation_type_concept_id 
    ,case when stelling in ('Aantal sigaretten per dag', 'Aantal packyears', 'Aantal sigaren per dag', 'Aantal stuks shag per dag', 'Aantal stuks pijp per dag') and antwoord <> '' then cast(replace(antwoord, ',', '.') as float64) else cast(null as float64) end as value_as_number
    ,case 
      when stelling in ('Gestopt met roken sinds (jaartal)', 'Rookt(e) sinds (jaartal)') then antwoord
      else cast(null as string)
    end as value_as_string
    ,cast(null as string) as value_as_concept_id
    ,cast(null as string) as qualifier_concept_id
    ,cast(null as string) as unit_concept_id
    ,concat('HIXVRAGENLIJSTEN_', vraagid) as observation_source_value
    ,cast(null as string) as observation_source_concept_id
    ,cast(null as string) as unit_source_value
    ,cast(null as string) as qualifier_source_value
    ,case when stelling = 'Roken' then omschr else antwoord end as value_source_value
    ,cast(null as string) as observation_event_id
    ,cast(null as string) as obs_event_field_concept_id
    from hixvragenlijsten where stelling <> 'Soort tabak'
    )

SELECT distinct cte.*
    , COALESCE(ARRAY_AGG(vd.provider_id ORDER BY vd.visit_detail_start_datetime DESC LIMIT 1)[OFFSET(0)], ARRAY_AGG(v.provider_id ORDER BY v.visit_start_datetime DESC LIMIT 1)[OFFSET(0)]) as provider_id
    , ARRAY_AGG(v.visit_occurrence_id ORDER BY v.visit_start_datetime DESC LIMIT 1)[OFFSET(0)] as visit_occurrence_id
    , ARRAY_AGG(vd.visit_detail_id ORDER BY vd.visit_detail_start_datetime DESC LIMIT 1)[OFFSET(0)] as visit_detail_id
FROM cte
LEFT OUTER JOIN {{project_id}}.{{dataset_id_work}}.visit_occurrence_upload v ON v.person_id = cte.person_id AND cast(cte.observation_datetime as datetime) >= v.visit_start_datetime and cast(cte.observation_datetime as datetime) <= v.visit_end_datetime 
LEFT OUTER JOIN {{project_id}}.{{dataset_id_work}}.visit_detail_upload vd ON v.visit_occurrence_id = vd.visit_occurrence_id AND cast(cte.observation_datetime as datetime) >= vd.visit_detail_start_datetime and cast(cte.observation_datetime as datetime) <= vd.visit_detail_end_datetime
inner join {{project_id}}.{{dataset_id_work}}.person_upload p
on cte.person_id = p.person_id
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18
order by 2