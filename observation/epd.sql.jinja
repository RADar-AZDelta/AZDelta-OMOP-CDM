SELECT
    CONCAT('EPD_', e.DIAG_ID) AS observation_id	
    ,e.PATIENTNR AS person_id
    ,i.sourceCode AS observation_concept_id
    ,DATE(COALESCE(e.DATUM, e.REGISTRATIONDATE)) AS observation_date
    ,DATETIME(
        DATE(COALESCE(e.DATUM, e.REGISTRATIONDATE)), 
        CASE
            WHEN REGEXP_CONTAINS(e.STARTTIJD, r'^[0-9]{2}:[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M:%S', e.STARTTIJD)
            WHEN REGEXP_CONTAINS(e.STARTTIJD, r'^[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M', e.STARTTIJD)
            ELSE TIME(0, 0, 0)
        END        
    ) AS observation_datetime
    ,'ADMINISTRATION_RECORD' AS observation_type_concept_id
    ,cast(NULL AS FLOAT64) AS value_as_number
    ,cast(NULL AS STRING) AS value_as_string
    ,CAST(NULL AS STRING) AS value_as_concept_id
    ,cast(NULL AS STRING) AS qualifier_concept_id
    ,cast(NULL AS STRING) AS unit_concept_id
    ,e.ARTSCODE AS provider_id
    ,ARRAY_AGG(vs.x IGNORE NULLS ORDER BY vs.x ASC)[SAFE_OFFSET(0)] visit_occurrence_id
    ,cast(NULL AS STRING) AS visit_detail_id
    ,i.sourceCode AS observation_source_value
    ,i.sourceCode AS observation_source_concept_id
    ,cast(NULL AS STRING) AS unit_source_value
    ,cast(NULL AS STRING) AS qualifier_source_value
    ,cast(null as string) as value_source_value
    ,cast(NULL AS int) AS observation_event_id
    ,cast(NULL AS STRING) AS obs_event_field_concept_id
FROM `{{project_id}}.{{dataset_id_raw}}.DOSSIER_EPDDIAG` e
LEFT JOIN `{{project_id}}.{{dataset_id_raw}}.CODELYST_CODEOMS` cc 
ON e.CODE = cc.CODE
INNER JOIN `{{project_id}}.{{dataset_id_work}}.condition_occurrence__condition_concept_id_usagi` i 
ON concat('EPD_', e.CODE) = i.sourceCode
LEFT JOIN `{{project_id}}.{{dataset_id_work}}.person_id_swap` p
ON e.PATIENTNR = p.x
LEFT JOIN `{{project_id}}.{{dataset_id_omop}}.visit_occurrence` v
ON DATE(e.DATUM) >= v.visit_start_date 
    AND DATE(e.DATUM) <= v.visit_end_date
    AND p.y = v.person_id
LEFT JOIN `{{project_id}}.{{dataset_id_work}}.visit_occurrence_id_swap` vs
ON v.visit_occurrence_ID = vs.y
WHERE e.CODE IS NOT NULL AND TRIM(e.CODE) <> '' 
    AND cc.Omschrijving IS NOT NULL AND TRIM(cc.Omschrijving) <> ''
    AND e.DIAG_ID IS NOT NULL AND TRIM(e.DIAG_ID) <> ''
    AND e.PATIENTNR IS NOT NULL AND TRIM(e.PATIENTNR) <> ''
    AND i.domainId not in ("Condition","Procedure","Drug","Measurement","Device")
GROUP BY e.DIAG_ID, e.PATIENTNR, i.sourceCode, e.DATUM, e.REGISTRATIONDATE, e.STARTTIJD, e.EINDDATUM, e.EINDTIJD, e.ARTSCODE
