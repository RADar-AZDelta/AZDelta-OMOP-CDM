{# Copyright 2022 RADar-AZDelta #}
{# SPDX-License-Identifier: gpl3+ #}
SELECT DISTINCT
  tables.concept_name sourceCode
  , tables.concept_name sourceName
  , 0 sourceFrequency
  , cast(null as string) sourceAutoAssignedConceptIds
  , 1 matchScore
  , "APPROVED" mappingStatus
  , "EQUAL" equivalence
  , "etl" statusSetBy
  , UNIX_MILLIS(CURRENT_TIMESTAMP()) as statusSetOn
  , fields.concept_id conceptId
  , fields.concept_name conceptName
  , fields.domain_id domainId
  , "MAPS_TO" mappingType
  , 'AUTO MAPPED' AS comment
  ,'etl' AS createdBy
  ,UNIX_MILLIS(CURRENT_TIMESTAMP()) as createdOn
  ,cast(null AS string) AS assignedReviewer
FROM `{{project_id}}.{{dataset_id_omop}}.concept` tables
INNER JOIN `{{project_id}}.{{dataset_id_omop}}.concept_relationship` tables_to_cdm
ON tables_to_cdm.relationship_id = "Contained in version" 
  AND tables_to_cdm.concept_id_1 = tables.concept_id
INNER JOIN `{{project_id}}.{{dataset_id_omop}}.concept_relationship` to_fields
ON to_fields.relationship_id = "Subsumes" 
  AND to_fields.concept_id_1 = tables.concept_id
INNER JOIN `{{project_id}}.{{dataset_id_omop}}.concept` fields
ON to_fields.concept_id_2 = fields.concept_id
INNER JOIN `{{project_id}}.{{dataset_id_omop}}.concept_relationship` fields_to_cdm
ON fields_to_cdm.relationship_id = "Contained in version" 
  AND fields_to_cdm.concept_id_1 = fields.concept_id 
INNER JOIN `{{project_id}}.{{dataset_id_omop}}.cdm_source` cdm
ON tables_to_cdm.concept_id_2 = cdm.cdm_version_concept_id AND fields_to_cdm.concept_id_2 = cdm.cdm_version_concept_id
WHERE tables.standard_concept = 'S'
  AND tables.vocabulary_id = "CDM"
  AND tables.domain_id = "Metadata"
  AND fields.standard_concept = 'S'
  AND fields.vocabulary_id = "CDM"
  AND fields.domain_id = "Metadata"
  AND (fields.concept_name = concat(tables.concept_name,'.',tables.concept_name,"_id")
        OR (tables.concept_name = "death" and fields.concept_name = concat(tables.concept_name,".person_id")))