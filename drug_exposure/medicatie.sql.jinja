SELECT DISTINCT
    IF(deel.CODE IS NULL
        , CONCAT('MEDICATIE_', patientnr,'_', med.code, '_', identif)
        , CONCAT('MEDICATIE_', patientnr,'_', med.code, '_', identif, '_', deel.CODE)
        ) AS DRUG_EXPOSURE_ID
    , patientnr AS person_id
    , CASE
        WHEN LENGTH(atccode) = 7 OR (TRIM(omschr) = TRIM(medicoms) OR TRIM(medicoms) = '')
            THEN CONCAT('MEDICATIE_', med.code)
        WHEN deel.CODE IS NULL
            THEN CONCAT('MEDICATIE_', med.code, '_', identif)
        ELSE CONCAT('MEDICATIE_', med.code, '_', identif, '_', deel.CODE)
      END AS DRUG_CONCEPT_ID
    , CAST(IFNULL(deel.tddatum, MIN(vrschrdat)) as DATE) AS DRUG_EXPOSURE_START_DATE
    --, IFNULL(CAST(CONCAT(tddatum, ' ', IF(tdtijd IS NOT NULL AND TRIM(tdtijd) <> '', tdtijd, '00:00:00')) AS DATETIME), CAST(CONCAT(MIN(vrschrdat), ' 00:00:00') AS DATETIME)) AS DRUG_EXPOSURE_START_DATETIME 
    ,DATETIME(
        CAST(IFNULL(deel.tddatum, MIN(vrschrdat)) as DATE),
        CASE
            WHEN REGEXP_CONTAINS(deel.tdtijd, r'^[0-9]{2}:[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M:%S', deel.tdtijd)
            WHEN REGEXP_CONTAINS(deel.tdtijd, r'^[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M', deel.tdtijd)
            ELSE TIME(0, 0, 0)
        END
    )  as DRUG_EXPOSURE_START_DATETIME
    , CAST(IFNULL(tddatum, date_add(MAX(vrschrdat), INTERVAL 29 DAY)) as DATE) AS DRUG_EXPOSURE_END_DATE
    --, IFNULL(CAST(CONCAT(tddatum, ' ',IF(tdtijd IS NOT NULL AND TRIM(tdtijd) <> '', tdtijd, '00:00:00')) AS DATETIME), CAST(CONCAT(date_add(MAX(vrschrdat), INTERVAL 29 DAY), ' 00:00:00') AS DATETIME)) AS DRUG_EXPOSURE_END_DATETIME
    ,DATETIME(
        CAST(IFNULL(tddatum, date_add(MAX(vrschrdat), INTERVAL 29 DAY)) as DATE),
        CASE
            WHEN REGEXP_CONTAINS(deel.tdtijd, r'^[0-9]{2}:[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M:%S', deel.tdtijd)
            WHEN REGEXP_CONTAINS(deel.tdtijd, r'^[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M', deel.tdtijd)
            ELSE TIME(0, 0, 0)
        END
    )  as DRUG_EXPOSURE_END_DATETIME
    , CAST(IFNULL(IFNULL(COALESCE(MAX(actstopdt), MAX(enddate)), tddatum), NULL) as DATE) AS VERBATIM_END_DATE
    , 'MEDICATIE_TYPE' AS DRUG_TYPE_CONCEPT_ID
    , CAST(stpreden AS STRING) AS STOP_REASON
    , CAST(NULL AS INT64) AS REFILLS
    , CAST(0 AS FLOAT64) AS QUANTITY
    , CAST(DATE_DIFF(IFNULL(COALESCE(MAX(enddate), MAX(actstopdt)), tddatum), COALESCE(tddatum, MIN(vrschrdat)), day) AS INT64) AS DAYS_SUPPLY
    , CAST(schemaoms AS STRING) AS SIG
    , CONCAT('MEDICATIE_', rec.toedcd) AS ROUTE_CONCEPT_ID
    , CAST(NULL AS STRING) AS LOT_NUMBER
    , CAST(NULL AS STRING) AS PROVIDER_ID
    , CAST(NULL AS STRING) AS VISIT_OCCURRENCE_ID
    , CAST(NULL AS STRING) AS VISIT_DETAIL_ID
    , IF(medicoms IS NOT NULL AND TRIM(MEDICOMS) <> '' AND LENGTH(medicoms) > LENGTH(omschr), medicoms, omschr) AS DRUG_SOURCE_VALUE
    , cast(coalesce(c.concept_id, 0) as int64) as drug_source_concept_id
    , CAST(toedoms AS STRING) AS ROUTE_SOURCE_VALUE
    , CAST(NULL AS STRING) AS DOSE_UNIT_SOURCE_VALUE 
from {{project_id}}.{{dataset_id_raw}}.MEDICAT_RECDEEL rec
left join {{project_id}}.{{dataset_id_raw}}.MEDICAT_DEELLST deel on rec.identif = deel.mocode
left join {{project_id}}.{{dataset_id_raw}}.MEDICAT_MEDICIJN med on med.code = rec.medcd
left join {{project_id}}.{{dataset_id_raw}}.ZINDEX_004RIZIV riz on med.IMPCD = riz.ATKODE and riz.ISCNK = true and riz.VERVALLEN = false
left join {{project_id}}.{{dataset_id_omop}}.concept c on c.concept_code = atccode and c.VOCABULARY_ID = 'ATC'
where rec.geaccordee = true
  and ((rec.vrschrtyp in ('K') and deel.toegediend = true) --ziekenhuis en toegediend
    or rec.vrschrtyp in ('R', 'P', 'V')) --rusthuis/thuis/vaccin
GROUP BY patientnr, identif, med.code, omschr, medicoms, stpreden, schemaoms, rec.toedcd, atccode, toedoms, deel.code, tdtijd, tddatum, c.concept_id
