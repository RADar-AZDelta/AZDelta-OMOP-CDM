{# Copyright 2022 RADar-AZDelta #}
{# SPDX-License-Identifier: gpl3+ #}

{# TODO: add Device/Procedure/Observation/Meas Value to other tables #}

with cte as (
    SELECT DISTINCT
        IF(deel.CODE IS NULL
            , CONCAT('MEDICATIE_', patientnr,'_', med.code, '_', identif)
            , CONCAT('MEDICATIE_', patientnr,'_', med.code, '_', identif, '_', deel.CODE)
            ) AS drug_exposure_id
        , patientnr AS person_id
        , CASE
            WHEN LENGTH(atccode) = 7 OR (TRIM(omschr) = TRIM(medicoms) OR TRIM(medicoms) = '')
                THEN CONCAT('MEDICATIE_', med.code)
            WHEN deel.CODE IS NULL
                THEN CONCAT('MEDICATIE_', med.code, '_', identif)
            ELSE CONCAT('MEDICATIE_', med.code, '_', identif, '_', deel.CODE)
        END AS drug_concept_id
        , DATE(IFNULL(deel.tddatum, MIN(IF(rec.VRSCHRDAT > CURRENT_TIMESTAMP(), rec.ACCDAT, rec.VRSCHRDAT)))) AS drug_exposure_start_date
        , DATETIME(
            DATE(IFNULL(deel.tddatum, MIN(IF(rec.VRSCHRDAT > CURRENT_TIMESTAMP(), rec.ACCDAT, rec.VRSCHRDAT)))),
            CASE
                WHEN REGEXP_CONTAINS(deel.tdtijd, r'^[0-9]{2}:[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M:%S', deel.tdtijd)
                WHEN REGEXP_CONTAINS(deel.tdtijd, r'^[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M', deel.tdtijd)
                ELSE TIME(0, 0, 0)
            END
        )  as drug_exposure_start_datetime
        , DATE(IFNULL(tddatum, date_add(MAX(IF(rec.VRSCHRDAT > CURRENT_TIMESTAMP(), rec.ACCDAT, rec.VRSCHRDAT)), INTERVAL 29 DAY))) AS drug_exposure_end_date
        , DATETIME(
            DATE(IFNULL(tddatum, date_add(MAX(IF(rec.VRSCHRDAT > CURRENT_TIMESTAMP(), rec.ACCDAT, rec.VRSCHRDAT)), INTERVAL 29 DAY))),
            CASE
                WHEN REGEXP_CONTAINS(deel.tdtijd, r'^[0-9]{2}:[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M:%S', deel.tdtijd)
                WHEN REGEXP_CONTAINS(deel.tdtijd, r'^[0-9]{2}:[0-9]{2}$') THEN PARSE_TIME('%H:%M', deel.tdtijd)
                ELSE TIME(0, 0, 0)
            END
        )  as drug_exposure_end_datetime
        , DATE(IFNULL(IFNULL(COALESCE(MAX(actstopdt), MAX(enddate)), tddatum), NULL)) AS verbatim_end_date
        , 'MEDICATIE_TYPE' AS drug_type_concept_id
        , CAST(stpreden AS STRING) AS stop_reason
        , CAST(NULL AS INT64) AS refills
        , CAST(0 AS FLOAT64) AS quantity
        , CAST(DATE_DIFF(IFNULL(COALESCE(MAX(enddate), MAX(actstopdt)), tddatum), COALESCE(tddatum, MIN(vrschrdat)), day) AS INT64) AS days_supply
        , CAST(schemaoms AS STRING) AS sig
        , CONCAT('MEDICATIE_', rec.toedcd) AS route_concept_id
        , CAST(NULL AS STRING) AS lot_number
        , rec.AANVRCODE AS provider_id
        --, CAST(NULL AS STRING) AS visit_occurrence_id
        --, CAST(NULL AS STRING) AS visit_detail_id
        , IF(medicoms IS NOT NULL AND TRIM(MEDICOMS) <> '' AND LENGTH(medicoms) > LENGTH(omschr), medicoms, omschr) AS drug_source_value
        , CASE
            WHEN LENGTH(atccode) = 7 OR (TRIM(omschr) = TRIM(medicoms) OR TRIM(medicoms) = '')
                THEN CONCAT('MEDICATIE_', med.code)
            WHEN deel.CODE IS NULL
                THEN CONCAT('MEDICATIE_', med.code, '_', identif)
            ELSE CONCAT('MEDICATIE_', med.code, '_', identif, '_', deel.CODE)
        END as drug_source_concept_id
        , CAST(toedoms AS STRING) AS route_source_value
        , CAST(NULL AS STRING) AS dose_unit_source_value 
    from {{project_id}}.{{dataset_id_raw}}.MEDICAT_RECDEEL rec
    left join {{project_id}}.{{dataset_id_raw}}.MEDICAT_DEELLST deel on rec.identif = deel.mocode
    left join {{project_id}}.{{dataset_id_raw}}.MEDICAT_MEDICIJN med on med.code = rec.medcd
    left join {{project_id}}.{{dataset_id_raw}}.ZINDEX_004RIZIV riz on med.IMPCD = riz.ATKODE and riz.ISCNK = true and riz.VERVALLEN = false
    where rec.geaccordee = true
        and ((rec.vrschrtyp in ('K') and deel.toegediend = true) --ziekenhuis en toegediend
            or rec.vrschrtyp in ('R', 'P', 'V')) --rusthuis/thuis/vaccin
        and patientnr is not null and med.code is not null and identif is not null
    GROUP BY patientnr, identif, med.code, omschr, medicoms, stpreden, schemaoms, rec.toedcd, rec.AANVRCODE, atccode, toedoms, deel.code, tdtijd, tddatum
), cte_filt_drug as (
    SELECT cte.*
    FROM cte
    INNER JOIN `{{project_id}}.{{dataset_id_omop}}.source_to_concept_map` scm
    ON cte.drug_concept_id = scm.source_code
    INNER JOIN `{{project_id}}.{{dataset_id_omop}}.concept` c
    ON scm.target_concept_id = c.concept_id
    WHERE c.domain_id = 'Drug'
)

SELECT cte.*
    {# , v.visit_occurrence_id
    , vd.visit_detail_id #}
    , ARRAY_AGG(v.visit_occurrence_id ORDER BY v.visit_start_datetime DESC LIMIT 1)[OFFSET(0)] as visit_occurrence_id
    , ARRAY_AGG(vd.visit_detail_id ORDER BY vd.visit_detail_start_datetime DESC LIMIT 1)[OFFSET(0)] as visit_detail_id
FROM cte_filt_drug cte
LEFT OUTER JOIN {{project_id}}.{{dataset_id_work}}.visit_occurrence_upload v ON v.person_id = cte.person_id AND cte.drug_exposure_start_date >= v.visit_start_datetime and cte.drug_exposure_start_date <= v.visit_end_datetime 
LEFT OUTER JOIN {{project_id}}.{{dataset_id_work}}.visit_detail_upload vd ON vd.visit_occurrence_id = v.visit_occurrence_id AND cte.drug_exposure_start_date >= vd.visit_detail_start_datetime and cte.drug_exposure_start_date <= vd.visit_detail_start_datetime
inner join {{project_id}}.{{dataset_id_work}}.person_upload p
on cte.person_id = p.person_id
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21

{# LEFT OUTER JOIN (
  SELECT  
    ANY_VALUE(cte).drug_exposure_id, 
    ARRAY_AGG(STRUCT(v.visit_occurrence_id) ORDER BY v.visit_start_datetime DESC LIMIT 1)[OFFSET(0)].*
  FROM cte
  JOIN {{project_id}}.{{dataset_id_work}}.visit_occurrence_upload v ON v.person_id = cte.person_id AND cte.drug_exposure_start_date >= v.visit_start_datetime and cte.drug_exposure_start_date <= v.visit_end_datetime
  GROUP BY FORMAT('%t', cte)
) v USING(drug_exposure_id)
LEFT OUTER JOIN (
  SELECT  
    ANY_VALUE(cte).drug_exposure_id, 
    ARRAY_AGG(STRUCT(vd.visit_detail_id) ORDER BY vd.visit_detail_start_datetime DESC LIMIT 1)[OFFSET(0)].*
  FROM cte
  JOIN {{project_id}}.{{dataset_id_work}}.visit_detail_upload vd ON vd.person_id = cte.person_id AND cte.drug_exposure_start_date >= vd.visit_detail_start_datetime and cte.drug_exposure_start_date <= vd.visit_detail_end_datetime
  GROUP BY FORMAT('%t', cte)
) vd USING(drug_exposure_id)  #}